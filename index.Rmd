---
title: "Regress√£o Log√≠stica"
subtitle: "Vis√£o Geral"
author: "Adriana Andrade"
institute: "UFRRJ"
date: "2021/07/02"
output:
   xaringan::moon_reader:
     css: [default, metropolis, metropolis-fonts]
   lib_dir: libs
   nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---
layout: true
<div style="position: absolute;right:50px;top:11px;color:gray;">`r rmarkdown::metadata$author` - `r rmarkdown::metadata$institute`</div>

```{r xaringan-tile-view, echo=FALSE}
xaringanExtra::use_tile_view()
```


```{r, include=FALSE}
xaringanExtra::use_logo('fig/logo.png')
```


```{r  adds a share bar to your slides, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r xaringan-scribble, echo=FALSE}
xaringanExtra::use_scribble()
```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```



```{r xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```


```{r setup, include=FALSE}
# https://ourcodingclub.github.io/2016/11/24/rmarkdown-1.html
knitr::opts_chunk$set(fig.width = 7, fig.height = 5, fig.align = 'center', dpi = 96, cache=TRUE, comment = "", message = F, warning = F)

```

```{r - Packages, echo=FALSE}
library(readr)
library(tidyverse)
library(ggplot2)
library(pander)
library(xaringanExtra)
library(mfx)
library(kableExtra)
library(knitr)

```
---
background-image: url(https://gordoncstewart.files.wordpress.com/2016/01/to-be-or-not-to-be.jpg)
background-size: cover

---


#Regress√£o Log√≠stica


## Roteiro

- Propriedades do Modelo de Regress√£o Log√≠stica
- Testes utilizados nessa modelagem
- Interpreta√ß√£o dos resultados
- Aplica√ß√£o
- Pr√°tica


---
# Regress√£o Log√≠stica

## Aspectos Gerais do MRLog

O MRLog frequentemente √© utilizado para analisar dados observacionais ou experimentais de delineamentos inteiramente casualizados nos casos em que a vari√°vel resposta assume unicamente dois valores poss√≠veis.

--

Enquanto a vari√°vel resposta √© categ√≥rica com dois n√≠veis, as vari√°veis explicativas podem ser categ√≥ricas ou n√£o.

---
# Regress√£o Log√≠stica


## Perspectiva do MRLog

**Descritivo**: descrever a natureza do relacionamento entre a resposta m√©dia e as vari√°veis regressoras.

**Preditivo**: prever com base nas vari√°veis explicativas, a probabilidade de um elemento apresentar um dado desfecho.

---

#Regress√£o Log√≠stica


## Aplica√ß√µes do MRLog

- Identificar caracter√≠sticas associadas com a ocorr√™ncia de uma doen√ßa cr√¥nica;
- Identificar caracter√≠sticas associadas com um determinado status;
- Previs√£o do risco: calcular a probabilidade de consumidores serem inadimplentes ou adimplentes;
- Previs√£o de paciente aderir a um tratamento medicamentoso;
- Classificar: a empresa encontra-se no grupo de empresas solventes ou insolventes;
- Classificar e-mails em spam ou n√£o;


---
## Caracter√≠sticas do Modelo: Linear x Log√≠stico
.pull-left[
**Regress√£o Linear**
- Vari√°vel resposta: cont√≠nua
- M√≠nimo Quadrados
- Gr√°fico: Reta
- $E(Y) = \hat{y}$
]
.pull-right[

**Regress√£o Log√≠stica**
- Vari√°vel resposta: bin√°ria
- M√°xima Verossimilhan√ßa
- Gr√°fico: curva log√≠stica no formato da letra S
- $E(Y) = \hat{p}$

]
---

## Gr√°fico de Ajuste: Linear x Log√≠stico

.pull-left[

```{r, echo=FALSE}
mtcars %>% 
  ggplot(aes(x=mpg, y=vs))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  ylab("Valor Predito")+
  xlab("Vari√°vel Explicativa")+
  ggtitle("Gr√°fico - Ajuste Modelo Linear")

```

]
.pull-right[

```{r, echo=FALSE}
mtcars %>% 
  ggplot(aes(x=mpg, y=vs))+
  geom_point()+
  geom_smooth(method = "glm",method.args = list(family = "binomial"), se = FALSE)+
  ylab("Valor Predito")+
  xlab("Vari√°vel Explicativa")+
  ggtitle("Gr√°fico - Ajuste Modelo Log√≠stico")
```

]


---
## Conte-me mais detalhes...

```{r, out.width="70%", echo=FALSE}
knitr::include_graphics("https://media4.giphy.com/media/mlvseq9yvZhba/giphy.gif")

```
---
# Regress√£o Log√≠stica

## Modelos Lineares Generalizados

O Modelo de Regress√£o Log√≠stica (MRLog) faz parte da classe dos Modelos Lineares Generalizados, em que a vari√°vel resposta Y pertence √† fam√≠lia exponencial. Nesses casos, a rela√ß√£o entre a vari√°vel resposta e as vari√°veis preditoras √© realizada por uma fun√ß√£o de liga√ß√£o. 

--

O objetivo dos Modelos Lineares Generalizados √© obter para uma vari√°vel resposta que n√£o possui distribui√ß√£o Normal uma rela√ß√£o linear nos par√¢metros das vari√°veis preditoras, ou seja, um preditor linear $\eta = \beta_0 +\beta_1X_{1i}$, a partir de uma fun√ß√£o de liga√ß√£o que relaciona a vari√°vel resposta com as vari√°veis preditoras.

--

A fun√ß√£o de liga√ß√£o utilizada no Modelo de Regress√£o Log√≠stica √© a fun√ß√£o logit.


---
# Regress√£o Log√≠stica


## Defini√ß√£o

Considere Yi uma v.a. Bernoulli 

$Y_i=0$ ou $Y_i=1$

A distribui√ß√£o de probabilidade de $Y_i$ √© dada por:

$Y_i = 1$ => $P(Y_i=1) = p_i$

$Y_i = 0$ => $P(Y_i=0) = 1 - p_i$

Temos que o valor esperado de $Y_i$:

$E(Y_i) = p_i$


---

# Regress√£o Log√≠stica


## Defini√ß√£o

- O MRLog modela uma probabilidade de ocorr√™ncia.

- A resposta m√©dia, quando a vari√°vel resposta √© uma vari√°vel bin√°ria (1 ou 0), sempre representa a probabilidade $p_i$ para $Y=1$ , dado o n√≠vel da vari√°vel preditora $X$. 

.center[ $$m√©dia(Y) = E(Y)=P(Y=1|x)$$]


---

# Regress√£o Log√≠stica

### Restri√ß√µes relacionadas com a vari√°vel resposta


**1) Valor predito √© uma probabilidade**

$0 \leq E(Y_i) = P(Y=1|x) \leq 1$

Tendo em vista que a vari√°vel resposta modela uma probabilade,tem-se que seus poss√≠veis valores estar√£o no intervalo [0;1], portanto, essa vari√°vel torna-se inapropriada para uma fun√ß√£o de resposta linear.

---

# Regress√£o Log√≠stica

### Restri√ß√µes relacionadas com a vari√°vel resposta


**2) Desfecho n√£o tem distribui√ß√£o Normal**


 Portanto, os erros n√£o tem distribui√ß√£o normal

$\epsilon_i = Y_i-(\hat{\beta}_0+\hat{\beta}_1X_{1i})$

Os erros ir√£o assumir dois valores:

$Y_i=1$ => $\epsilon_i = 1-(\hat{\beta_0}+\hat{\beta}_1X_{1i})$


$Y_i=0$ => $\epsilon_i = -(\hat{\beta_0}+\hat{\beta}_1X_{1i})$
---

# Regress√£o Log√≠stica

### Restri√ß√µes relacionadas com a vari√°vel resposta

**3) ùê∑ùëÉ(ùëå)‚àùùê∏(ùëå) ‚Äì Vari√¢ncia n√£o √© constante, viola√ß√£o da suposi√ß√£o de homocedasticidade**

$\epsilon_i = y_i - \hat{y_i} = y_i -\hat{p_i}$

$\sigma^2(\epsilon_i) = \hat{p}_i(1-\hat{p}_i) = (\hat{\beta}_0+\hat{\beta}_1X_{1i})(1-\hat{\beta}_0-\hat{\beta}_1X_{1i})$

 - A vari√¢ncia depende do valor de $X_i$

---
# Regress√£o Log√≠stica

##  Transforma√ß√£o Logit da probabilidade *p*


Tendo em vista que a vari√°vel resposta $Y$ varia entre 0 e 1, ser√° definida uma transforma√ß√£o da vari√°vel resposta de modo que o seu dom√≠nio seja ampliado e que a rela√ß√£o entre a vari√°vel resposta e as vari√°veis explicativas seja representada por um preditor linear:

$$\eta = \beta_0 +\beta_1X_{1i}$$

Portanto, em raz√£o da n√£o linearidade da vari√°vel resposta, ser√° preciso definir uma quantidade que possibilite a liga√ß√£o entre $Y$ e $\eta$:

Essa quantidade ser√° o **log(logit de p)**.

---
# Regress√£o Log√≠stica

## Transforma√ß√£o Logit da probabilidade *p*


A fun√ß√£o de liga√ß√£o ser√° estabelecida com a seguinte quantidade:

 .center[$$odds = \frac{p}{1-p}$$]

A **odds** (vantagem) √© a raz√£o entre a probabilidade de ocorr√™ncia e a probabilidade de n√£o-ocorr√™ncia do desfecho de interesse.

---

# Regress√£o Log√≠stica

## Transforma√ß√£o Logit da probabilidade *p*


O logit da vari√°vel resposta $Y$ √© uma vari√°vel cont√≠nua que √© calculado como o logaritmo natural da vantagem (odds):

.center[$$ logit = ln(odds) =ln \left ( \frac{p}{1-p}  \right ) $$]
---
# Regress√£o Log√≠stica

### Fun√ß√£o de Liga√ß√£o Logit

A lineariza√ß√£o do preditor ocorre com o uso da quantidade **logit**.


$$ ln \left ( \frac{p}{1-p}  \right ) = \beta_0 + \beta_1X     $$
Aplicando o exponencial no logit, temos: 


$$ \hat{p_i}= \frac {e^{\beta_0 + \beta_1X}}{1 +e^{(\beta_0 + \beta_1X)}} = \frac {1}{1 +e^{-(\beta_0 + \beta_1X)}} $$

---
# Regress√£o Log√≠stica

### Probabilidade estimada

O MRLog estima a probabilidade de ocorr√™ncia de um evento.

$$P(Y=1)= \frac {e^{\beta_0 + \beta_1X}}{1 +e^{(\beta_0 + \beta_1X)}} = \frac {1}{1 +e^{-(\beta_0 + \beta_1X)}}$$

---

# Regress√£o Log√≠stica

## Suposi√ß√µes do Modelo de Regress√£o Log√≠stica


- Nenhuma vari√°vel importante foi omitida;
- Aus√™ncia de vari√°veis esp√∫rias;
- Vari√°veis independentes foram mensuradas corretamente;
- Aus√™ncia de  observa√ß√µes influentes;
- As observa√ß√µes s√£o independentes;
- As vari√°veis independentes n√£o s√£o combina√ß√µes lineares umas das outras. 


A n√£o observ√¢ncia dos resquisitos do modelo pode produzir estimativas de coeficientes enviesadas ou erros-padr√µes elevados, o que impossibilita a produ√ß√£o de infer√™ncias v√°lidas.


---
# Regress√£o Log√≠stica

##Estimador de M√°xima Verossimilhan√ßa


Busca a combina√ß√£o de coeficientes que maximiza a probabilidade da amostra ter sido observada. Sendo assim, procura obter par√¢metros que maximize a fun√ß√£o de verossimilhan√ßa (*L*).

.center[$$L=\prod_{i=1}^nf(x_i,\theta)$$]

A fun√ß√£o de verosimilhan√ßa √© uma medida da informa√ß√£o fornecida pelos dados para os par√¢metros de um modelo probabil√≠stico. Produz estimativas para os par√¢metros que tornam os dados amostrais mais prov√°veis.

---
# Regress√£o Log√≠stica

##Estimador de M√°xima Verossimilhan√ßa para o MRLog


A probabilidade de ocorr√™ncia de $Y_i$ √© dada por:

$$P(Y_i) = (p_i)^{Y_i}(1-p_i)^{1-Y_i}$$


Com base nessa informa√ß√£o, √© definida a fun√ß√£o de verossimilhan√ßa:

$$L=\prod_{i=1}^n(p_i)^{Y_i}(1-p_i)^{1-Y_i}$$


 $$L = \prod_{i=1}^n\left [  \left ( \frac{\epsilon^{\eta}}{(1+\epsilon^{\eta})} \right )^{Y_i}  \left ( \frac{1}{(1+\epsilon^{\eta})} \right )^{1-Y_i}  \right ]$$

---
# Regress√£o Log√≠stica

##Estimador de M√°xima Verossimilhan√ßa para o MRLog

Por conveni√™ncia de c√°lculo, nesse ponto, aplica-se o logaritmo natural em ambos os lados da equa√ß√£o de verossimilhan√ßa:


 $LogL \sum_{i=1}^n \left \{ \left [Y_iln \left(\frac{e^{\eta}}{1+e^{\eta}} \right)  \right]  + \left [(1 - Y_i)ln \left(\frac{e^{\eta}}{1+e^{\eta}} \right)  \right]     \right \}$
 


---
# Regress√£o Log√≠stica

## Estima√ß√£o dos Coeficientes do Modelo

A signific√¢ncia estat√≠stica dos coeficientes estimados √© testada a partir da Estat√≠stica de *Wald*, que possui distribui√ß√£o Normal, com base no erro padr√£o dos coeficientes.

Hip√≥teses:

$H_0:\beta_j=0$

$H_1:\beta_j\neq0$


- **Estat√≠stica de Wald**

$Wald = \frac{\hat{\beta}_j}{se(\hat{\beta}_j)}~N(0,1)$

---
# Regress√£o Log√≠stica

## Intervalo de Confian√ßa para os par√¢metros

Um intervalo de confian√ßa $(1-\alpha)$ para $\beta_j$ √© dado por

$\hat{\beta_j} \pm z_{\alpha/2}\hat{se(\beta_j)}$


---

# Regress√£o Log√≠stica

## Valores Preditos

O modelo de regress√£o log√≠sitca possibilita a obten√ß√£o de dos valores preditos, ou seja, √© poss√≠vel obter a probabilidade de ocorr√™ncia do desfecho de interesse condicionado √†s vari√°veis explicativas.


$$\hat{p_i}= \frac {e^{\hat{\beta}_0 + \hat{\beta}_1X_i}}{1 +e^{(\hat{\beta}_0 + \hat{\beta}_1X_i)}} = \frac {1}{1 +e^{-(\hat{\beta}_0 + \hat{\beta}_1X_i)}}$$
---

# Regress√£o Log√≠stica

## Interpreta√ß√£o - Efeito de $\hat{\beta_j}$ no Logit



- A an√°lise direta do valor do coeficiente reporta o efeito no logaritmo da odds (logit).

- Um coeficiente significativo com sinal POSITIVO indica que a vari√°vel est√° associada com a AUMENTO do logit;

- Um coeficiente significativo com sinal NEGATIVO indica que a vari√°vel est√° associada com a DIMINUI√á√ÉO do logit;

---

# Regress√£o Log√≠stica  

### Interpreta√ß√£o - Efeito de $exp(\hat{\beta})$ na OR


A odds ratio (OR) compara a probabilidade de ocorr√™ncia do evento de interesse para n√≠veis distintos de uma vari√°vel explicativa. 

 $$OR=\frac{p_{A_1}/(1-p_{A_1})}{p_{A_2}/(1-p_{A_2})}$$

Tendo em vista que o logit √© mensurado na escala logar√≠tmica, a exponencia√ß√£o do par√¢metro de regress√£o $\beta$ fornece o efeito na OR:


|Quantidade|Interpreta√ß√£o|
|----------|-------------|
|$$exp(\hat{\beta})>1$$  | aumento da OR|
|$$exp(\hat{\beta})<1$$  | dimini√ß√£o da OR|
|$$[exp(\hat{\beta})-1]\times 100 = \%$$  | mudan√ßa percentual na OR|


---

# Regress√£o Log√≠stica

## Intervalo de Confian√ßa para OR

- Uma maneira de avaliar a relev√¢ncia dos coeficientes estimados √© pela an√°lise do intervalo de confian√ßa calculados para a OR (**odds ratio**). 


- Quando um intervalo conter o valor 1, n√£o se tem evid√™ncias suficientes para concluir que h√° uma vantagem de ocorr√™ncia do desfecho em rela√ß√£o a sua n√£o ocorr√™ncia com base na vari√°vel explicativa.


---

# Regress√£o Log√≠stica

## Adequa√ß√£o do Modelo - Estat√≠stica da Deviance 

A Estat√≠stica da Deviance verifica a adequa√ß√£o do ajuste ao comparar o logaritmo da verossimilhan√ßa do modelo de pesquisa com o logaritmo da verossimilhan√ßa do modelo saturado, modelo que se ajusta completamente aos dados, isto √©, para cada observa√ß√£o tem-se um par√¢metro. 

--

- Um modelo bem ajustado aos dados apresentar√° uma elevada verossimilhan√ßa e, portanto, uma estat√≠stica de Deviance pequena. 

- Para obter uma redu√ß√£o da Deviance, deve-se aumentar o n√∫mero de par√¢metros do modelo, o que deve ser realizado com cautela em raz√£o do princ√≠pio da parcim√¥nia.

---

# Regress√£o Log√≠stica

## Adequa√ß√£o do Modelo - Estat√≠stica da Deviance

A estat√≠stica da Deviance √© obtida a partir de:

Deviance = $-2log(L_{M.saturado} - L_{M.pesquisa}) ~\chi^{2}_{n-p}$


*Hip√≥tese*

$H_0$: Modelo de *pesquisa* √© t√£o adequado quanto ao modelo *Saturado*



---

#Regress√£o Log√≠stica

## Adequa√ß√£o do Modelo - Raz√£o de Verossimilhan√ßas

A Estat√≠stica da Raz√£o de Verossimilhan√ßas √© utilizada para comparar modelos aninhados, ou seja, um modelo reduzido que cont√©m um menor n√∫mero de par√¢metros contidos em um modelo mais  completo. Sendo assim, possibilita comparar o efeito da inclus√£o de termos na modelagem.



$\lambda$ = 2(*Log_Verossimilhan√ßa Completo* - *Log_Verossimilhan√ßa M_Reduzido*) $~\chi_{(p-q)}^2$

onde $p$ representa o n√∫mero de par√¢metros do *M_Completo* e $q$ do *M_Reduzido*.


Hip√≥tese:

$H_0$: Modelo reduzido √© t√£o adquando quanto modelo completo.


---
# Regress√£o Log√≠stica

## Adequa√ß√£o do Ajuste - AIC (Akaike Information Criterion)


O AIC √© uma mediada obtida a partir do logaritmo da verossimilhan√ßa penalizado pelo n√∫mero de par√¢metros do modelo. Quanto menor o valor de AIC, melhor o ajuste do modelo. 

Primeiramente, √© calculado o AIC para o Modelo Nulo e em seguida se obt√©m o AIC para o Modelo de Pesquisa. Para a tomada de decis√£o, compara-se os dois valores de AIC calculados.


$AIC = -2 LogL+ 2p$

onde L represnta $f(x;\theta)$,a fun√ß√£o de verossimilhan√ßa do modelo, e $p$ o n√∫mero de vari√°veis do modelo de pesquisa.
---
# Regress√£o Log√≠stica

## Adequa√ß√£o do Ajuste - Outros aspectos

### Multicolinearidade
Multicolinearidade  ocorre quando duas ou mais vari√°veis independentes do modelo apresentam algum n√≠vel de correla√ß√£o. Se h√° uma elevada multicolinariedade entre algumas vair√°veis, o ajuste do modelo pode apresentar coeficientes com erros padr√µes elevados.
Para avaliar a presen√ßa de multicolinearidade utilizar as medidas de *toler√¢ncia* e *VIF (variance inflation factor)*

### Observa√ß√µes influentes
A presen√ßa de observa√ß√µes influentes pode ocasionar estimativas de coeficientes viciadas.


---

# Regress√£o Log√≠stica

## Qualidade do Ajuste - Pseudo $R^2$


- O Pseudo $R^2$ √© uma medida geral de como o modelo se ajusta aos dados.

- Essa medida √© semelhante ao $R^2$ obtido na regress√£o linear m√∫ltipla que representa a quantidade de variabilidade explicada pelo modelo. 

--

- O pseudo R-quadrado n√£o √© medido em termos de vari√¢ncia, uma vez que na regress√£o log√≠stica a vari√¢ncia √© fixada como a vari√¢ncia da distribui√ß√£o log√≠stica padr√£o. √â uma propor√ß√£o em termos da probabilidade de log.

- O Pseudo $R^2$ √© calculado a partir do logaritmo da verossimilhan√ßa do modelo nulo (contendo apenas o intercepto) e da verossimilhan√ßa do modelo pesquisa. Quanto maior a diferen√ßa entre essas duas quantidades, melhor a qualiade do ajuste.

--

$$Pseudo\ R^2 = \frac{-2LogL_{M.nulo}-(-2ogLL_{M.pesquisa})}{-2LogL_{M.nulo}}$$
---

# Regress√£o Log√≠stica

## Qualidade do Ajuste - Teste de Hosmer e Lemeshow

O teste de Hosmer e Lemeshow √© utilizado na avalia√ß√£o da qualidade do ajuste do modelo. O teste consiste em comparar a distribui√ß√£o dos valores previstos pelo modelo com os valores observados na amostra, tendo por refer√™ncia a distribi√ß√£o Qui-quadrado e a divis√£o dos valores sob teste em 10 grupos de igual tamanho. 

$H_0$: propor√ß√µes observadas e esperadas s√£o iguais => modelo bem ajustado.



---

# Regress√£o Log√≠stica

## Qualidade do Ajuste - Matriz de Confus√£o

Uma outra maneira de avaliar a qualidade do ajuste do MRLog √© obtida por uma tabela de classifica√ß√£o, denominada Matriz de Confus√£o. Essa tabela relaciona os valores observados na vari√°vel resposta com os valores preditos pelo modelo. 

--

Para esse fim, √© necess√°rio definir uma regra para classificar os valores preditos (as probabilidades) em uma vari√°vel dicot√¥mica que assumir√° o valor zero, caso a probabilidade de ocorr√™ncia for inferior ao limite estabelecido, ou 1 caso contr√°rio. Em geral, esse limite √© estabelecido em 0,5.



---
# Regress√£o Log√≠stica

## Qualiade do Ajuste -  Curva ROC

A Curva ROC (Receiver Operating Characteristic Curve) no contexto do modelo de regress√£o log√≠stica permite avaliar o potencial da capacidade preditiva do modelo estimado a partir da rela√ß√£o entre as medidas de sensibilidade (*verdadeiros positivos*) e de especificidade (*verdadeiros negativos*).


```{r, out.width='70%', fig.align='center',echo=FALSE}
knitr::include_graphics('fig/fig_matrizconfusao.png')

```
---

# Regress√£o Log√≠stica

## Qualidade do Ajuste -  Curva ROC

```{r, out.width='70%', fig.align='center',echo=FALSE}
knitr::include_graphics('fig/ROC.jpg')

```

---

# Regress√£o Log√≠stica

## Qualidade do Ajuste -  Curva ROC

A partir da √°rea definida sob a curva ROC, se define a medida AUC que quanto mais pr√≥ximo de 1 indica que o modelo fez uma excelente classifica√ß√£o. Quanto mais pr√≥ximo de 0,5 o valor da √°rea se aproximar, tem-se que o modelo realiza uma classifica√ß√£o aleat√≥ria. Valores acima de 0,7 s√£o aceit√°veis.


---
## Qualidade do Ajuste - Valida√ß√£o do Modelo

A an√°lise da qualidade da classifica√ß√£o √© realizada dividindo o conjunto de dados em dois:

 - uma parte para estima√ß√£o do modelo (treinamento)
 - outra parte para testar a efici√™ncia da classifica√ß√£o (classifica√ß√£o)

Para utilizar o modelo de regress√£o log√≠stica para classifica√ß√£o de dois grupos, utiliza-se o seguinte crit√©rio:

 se P(Y=1) > 0,5 ent√£o classifica-se Y=1
 se P(Y=1) < 0,5 ent√£o classifica-se Y=0
 
---
# Regress√£o Log√≠stica

## Nossa, que interessante!

 
```{r, out.width="70%", fig.align='center',echo=FALSE}
knitr::include_graphics("https://media1.giphy.com/media/Nm8ZPAGOwZUQM/giphy.gif")
```

---

class: inverse, center, middle

# Regress√£o Log√≠stica - Aplica√ß√£o

---

# Regress√£o Log√≠stica - Aplica√ß√£o


Camarano, A. A., Kanso, S., Mello, J. L., & Andrade, A. (2006). Est√£o fazendo a transi√ß√£o os jovens que n√£o estudam, n√£o trabalham e n√£o procuram trabalho?. Transi√ß√£o para a vida adulta ou vida adulta em transi√ß√£o, 259-290.

```{r, out.width='70%', fig.align='center', echo=FALSE}
knitr::include_graphics('fig/fig0.png')
```

---
# Regress√£o Log√≠stica - Aplica√ß√£o


Ajuste de um Modelo de Regress√£o Log√≠stica para identificar o impacto de vari√°veis na desfecho de interesse: jovem n√£o estudar e nem trabalhar - *"nem nem"*.



| $Y=1$   |Jovem n√£o estuda e nem trabalha|
|:-------:|-------------------------------|
| $Y=0$   |Jovem estuda ou trabalha ou os dois|



Jovens: pessoas com idade entre 15 e 29 anos.


Dados: IBGE/Censo Demogr√°fico de 2000.

---
# Regress√£o Log√≠stica - Aplica√ß√£o

## Codifica√ß√£o das vari√°veis

```{r, out.width='100%', fig.align='center', echo=FALSE}
knitr::include_graphics('fig/fig1.png')
```

---

# Regress√£o Log√≠stica - Aplica√ß√£o

## Coeficientes estimados 


```{r, out.width='70%', fig.align='center', echo=FALSE}
knitr::include_graphics('fig/fig2.png')

```

--
Sinal dos Coeficientes
```{r, out.width='50%', fig.align='center', echo=FALSE}
knitr::include_graphics('fig/fig3.png')
```

---

# Regress√£o Log√≠stica - Aplica√ß√£o

##Resultados - Probabilidades


```{r, out.width='70%', fig.align='center', echo=FALSE}
knitr::include_graphics('fig/fig4.png')
```

---
# Regress√£o Log√≠stica - Aplica√ß√£o

##Resultados - Probabilidades


```{r, out.width='70%', fig.align='center', echo=FALSE}
knitr::include_graphics('fig/fig5.png')
```

---
# Regress√£o Log√≠stica

## Que tal ajustarmos um modelo?
 
```{r, out.width="70%", fig.align='center',echo=FALSE}
knitr::include_graphics("https://media3.giphy.com/media/CjmvTCZf2U3p09Cn0h/giphy-downsized.gif")
```

---

class: inverse, center, middle

# Regress√£o Log√≠stica - Exerc√≠cio


---
# MRLog - Exerc√≠cio

## Ajuste MRLog no R

**Fun√ß√£o glm** ‚Äì utilizada para ajustar modelos lineares generalizados e obter estimativas pontuais para os par√¢metros e algumas medidas de qualidade de ajuste.

Especificar:

- Vari√°vel dependente
- Vari√°veis explicativas
- Family - a distribui√ß√£o de probabilidade da vari√°vel resposta do modelo
- Link ‚Äì fun√ß√£o de liga√ß√£o

As estat√≠sticas de adequa√ß√£o e diagn√≥stico ser√£o obtidas pelo pacote **blorr**.

---
# MRLog - Exerc√≠cio

## Data Titanic

Data sobre o Titanic, navio constru√≠do na Irlanda que naufragou quatro dias ap√≥s sua viagem inaugural, em 1912. Quando constru√≠do, o navio prometia ser o mais luxuoso e seguro de sua √©poca. Entretanto, estudos posteriores indicaram falhas no sistema de seguran√ßa e evacua√ß√£o. A estimativa √© de 1514 mortes entre os 2224 passageiros, ou seja, aproximadamente 68% da tripula√ß√£o.

---

# MRLog - Exerc√≠cio

.panelset[
.panel[.panel-name[R Code]
```{r data, echo=TRUE}
#install.packages("titanic")
library(titanic)
data<-titanic_train

```
]

.panel[.panel-name[Data]

```{r, echo=FALSE}
str(data)

```
]
]

---
# MRLog - Exerc√≠cio

**Parametriza√ß√£o do modelo**



|Vari√°vel | Nome | Defini√ß√£o | Categoria de base|
|---------|:----:|:----------|:----------------:|
| Sexo    | Sex  | Fem x Masc|  Masculino |
| Classe de embarque| Pclass |1¬™,2¬™,3¬™ | 3¬™|
| Idade   | Age  | anos - cont√≠nua| -|

---
# MRLog - Exerc√≠cio

```{r, echo=TRUE}

#Remo√ß√£o de missing values
data<-data[complete.cases(data),]


#Recodifica√ß√£o da vari√°vel Survived
data$Survived<-factor(data$Survived,
                      labels = c("Not survived","Survived"),
                      levels = c(0,1))


#Recodifica√ß√£o da Vari√°vel Sexo para factor
#Categoria de base: male
data$Sex<-factor(data$Sex,
                 ordered = TRUE,
                  levels = c("male","female"))


#Recodifica√ß√£o do n√≠vel 3¬™ classe para valor zero - categoria de base
data$Pclass[data$Pclass==3]<-0
data$Pclass<-factor(data$Pclass)

 
```

---
# MRLog - Exerc√≠cio

## An√°lise Explorat√≥ria

.pull-left[
```{r plot1, eval=FALSE}
data %>% 
 ggplot(aes(x = Survived)) +
  geom_bar()
  
  
```
]
.right-graph[

```{r plot1-label-out, ref.label="plot1",echo=FALSE,fig.dim=c(4.8, 4.5), out.width="50%"}
```

]

---
# MRLog - Exerc√≠cio

## An√°lise Explorat√≥ria

.pull-left[
```{r plot2, eval=FALSE}
data %>% 
  ggplot(aes(x=Survived,fill=Sex))+
  geom_bar(position="fill")+
  scale_fill_manual(values=c("blue","red"))
```
]
.right-graph[

```{r plot2-label-out, ref.label="plot2", echo=FALSE,fig.dim=c(4.8, 4.5), out.width="50%"}
```

]

---
# MRLog - Exerc√≠cio

## An√°lise Explorat√≥ria

.pull-left[
```{r plot3, eval=FALSE}
data %>% 
  ggplot(aes(x=Survived,fill=Pclass))+
  geom_bar(position="fill")
```
]
.right-graph[

```{r plot3-label-out, ref.label="plot3", echo=FALSE,fig.dim=c(4.8, 4.5), out.width="50%"}
```

]


---
# MRLog - Exerc√≠cio

## An√°lise Explorat√≥ria

.pull-left[
```{r plot4, eval=FALSE}
data %>% 
 ggplot(aes(x=factor(Survived),y=Age,fill=factor(Survived)))+
  geom_boxplot()
```
]
.right-graph[

```{r plot4-label-out, ref.label="plot4", echo=FALSE,fig.dim=c(4.8, 4.5), out.width="50%"}
```

]

---
# MRLog - Exerc√≠cio

.panelset[

.panel[.panel-name[R Code]

```{r ajuste, eval=FALSE}
#Ajuste do Modelo

m1<-glm(Survived~Sex+Pclass+Age, family = binomial(link="logit"), data=data)
summary(m1)
```

]

.panel[.panel-name[Output]

```{r ajuste1, echo=FALSE}
m1<-glm(Survived~Sex+Pclass+Age, family = binomial(link="logit"), data=data)
summary(m1)
```
]

]

---
# Modelo ajustado 
O modelo ajustado √© dado por 

$logito = -0.065 + 1.784Sex_F - 2.581PClass_1 + 1.271 PClass_1+ - 0.037Age$

--
- Todos os coeficientes estimados das vari√°veis do modelo de pesquisa s√£o estatisticamente significativos e, portanto,diferentes de zero.

--

Efeito das Vari√°veis na ocorr√™ncia do desfecho: Sobreviv√™ncia do Passageiro

|Coeficiente | Sinal | Efeito |
|:----------:|:-----:|:------:|
|Sexo_F | Positivo| Aumenta|
|Class_1| Positivo| Aumenta|
|Class_2| Positivo| Aumenta|
|Idade  | Negativo| Diminui|

--

Lembrando: o valor de $B_j$ representa o efeito no logit $p/(1-p)$, ou seja, no log da chance de sobreviver em rela√ß√£o a n√£o sobreviver.
---

# MRLog - Exerc√≠cio

## OR e interpreta√ß√£o
.panelset[

.panel[.panel-name[R Code]

```{r, eval=FALSE}
exp(cbind(OR=coef(m1),confint(m1)))
```
]

.panel[.panel-name[Output]

```{r, echo=FALSE}
exp(cbind(OR=coef(m1),confint(m1)))
```
]
.panel[.panel-name[Interpretation]

|Vari√°vel | OR | Interpreta√ß√£o|
|-------|----|--------------|
|Sex_F   | 5.95 | Mulheres possuem chance de sobreviv√™ncia 5,95 vezes maior que homens.
|Pclass1|13,21 | Passageiros da 1¬™ classe possuem chance de sobreviv√™ncia 13,21 vezes maior que chance de sobreviv√™ncia dos passageiros da 3¬™ classe.|
|Pclass2|3,56 | Passageiros da 2¬™ classe possuem chance de sobreviv√™ncia 3,56 vezes maior que chance de sobreviv√™ncia dos passageiros da 3¬™ classe.|
|Age  |0,96 | A cada ano de vida tem-se uma diminui√ß√£o na chance de sobreviv√™ncia na ordem de 0,96.

]
]

---
# Exemplo - C√≥digo R

## Valores preditos

Pode-se ainda obter os valores de probabilidade predita pelo modelo para valores espec√≠ficos da vari√°vel explicativa:


#Probabilidades Preditas

```{r}
prob<-function(sex,pclass1,pclass2,age)
  { 1 /(1+exp(-(-0.06500312 + (1.78387550*sex) + (2.58062532*pclass1) + 
       (1.27082605*pclass2) + (-0.03698527*age))))
}

```

|Perfil |Probabilidae|
|---------------------------|------------------|
|Mulher ‚Äì 40 anos ‚Äì 1 classe|`r prob(1,1,0,40)`|
|Mulher ‚Äì 40 anos ‚Äì 3 classe|`r prob(1,0,0,40)`|
|Homem  ‚Äì 40 anos ‚Äì 1 classe|`r prob(0,1,0,40)`|
|Homem  ‚Äì 40 anos ‚Äì 3 classe|`r prob(0,0,0,40)`|


---
# Exemplo - C√≥digo R

.panelset[
.panel[.panel-name[R Code]

```{r,eval=FALSE}
predito<-predict(m1,type="response")
datap<-cbind(data,predito)

datap %>% 
ggplot(aes(x=Age,y=predito,group=Sex,colour=Sex)) +
  geom_line(size = 1) +
  geom_point(size=1) + 
  labs(title = "Probabilidades Preditas",
       y = "Probabilidade", x = "Idade") + 
  scale_color_manual(values=c("cadetblue", "rosybrown1"))+
  facet_wrap(~Pclass,ncol=1 )
```
]

.panel[.panel-name[Plot]

```{r,echo=FALSE}

predito<-predict(m1,type="response")
datap<-cbind(data,predito)

datap %>% 
ggplot(aes(x=Age,y=predito,group=Sex,colour=Sex)) +
  geom_line(size = 1) +
  geom_point(size=1) + 
  labs(title = "Probabilidades Preditas",
       y = "Probabilidade", x = "Idade") + 
  scale_color_manual(values=c("cadetblue", "rosybrown1"))+
  facet_wrap(~Pclass,ncol=1 )
```

]

]
---
# MRLog - Exerc√≠cio


.pull-left[
```{r anova, eval=FALSE}
#ANOVA
anova(m1)
```
]

.right-graph[
```{r plot-label-out, ref.label="anova", echo=FALSE,fig.dim=c(4.8, 4.5), out.width="50%"}
```

]
---

# MRLog - Exerc√≠cio

##### Medidas de Adequa√ß√£o do Modelo

.panelset[

.panel[.panel-name[R Code]

```{r fit_stat, eval=FALSE}
library(blorr)
blorr::blr_model_fit_stats(m1)
```

]

.panel[.panel-name[Output]

```{r fit_stat_out, echo=FALSE}

blorr::blr_model_fit_stats(m1)
```
]

]

---
# MRLog - Exerc√≠cio

.panelset[

.panel[.panel-name[R Code]

```{r hl_stat, eval=FALSE}
##Estat√≠stica Hosmer and Lemeshow
blorr::blr_test_hosmer_lemeshow(m1)
```

]

.panel[.panel-name[Output]

```{r hl_stat_out, echo=FALSE}

blorr::blr_test_hosmer_lemeshow(m1)
```
]

]

---
# MRLog - Exerc√≠cio

.panelset[

.panel[.panel-name[R Code]

```{r mat_conf, eval=FALSE}
## Matriz de Confus√£o

blorr::blr_confusion_matrix(m1)
```

]

.panel[.panel-name[Output]

```{r mat_conf_out, echo=FALSE}

blorr::blr_confusion_matrix(m1)
```
]

]


---
# MRLog - Exerc√≠cio


#### Curva ROC


.panelset[
  
.panel[.panel-name[R code]

```{r,eval=FALSE}
library(pROC)
roc1<- plot.roc(data$Survived,fitted(m1))

plot(roc1,
     print.auc=TRUE,
     auc.polygon=TRUE, 
     auc.polygon.col="lightblue",
     print.thres=TRUE
     )
```
]

.panel[.panel-name[Plot]
```{r,echo=FALSE,warning=FALSE, comment=FALSE, message=FALSE}
library(pROC)
roc1<- plot.roc(data$Survived,fitted(m1))

plot(roc1,
     print.auc=TRUE,
     auc.polygon.col="lightblue",
     print.thres=TRUE
     )
```

]

]
---
# MRLog - Exerc√≠cio

.panelset[
  
.panel[.panel-name[R code]

```{r,eval=FALSE}
#Valida√ß√£o por Treinamento e Teste
library(caret)
set.seed(123)
indice <- createDataPartition(data$Survived, p = .80, list = FALSE)

#Aplica√ß√£o do √çndice na base
treinamento <- data[indice, ]
dim(treinamento)
teste <- data[-indice, ]
dim(teste)

#Ajuste do modelo de treinamento

m_train<- glm(Survived~Sex+Pclass+Age, family = binomial(link="logit"), data=treinamento)
summary(m_train)

#Predi√ß√£o da vari√°vel resposta no conjunto de teste
teste$Survived_pred <- predict(m_train, teste, type = "response")
teste$classifica<-ifelse(teste$Survived_pred>0.5,"Survived","Not Survived")

# Visualiza√ß√£o dos valores observados, preditos e classificados
valida<-teste[,c("Survived","Survived_pred","classifica")]
DT::datatable(valida, editable = list(target = 'row'))

```
]

.panel[.panel-name[Output]
```{r,echo=FALSE,warning=FALSE, comment=FALSE, message=FALSE,tidy=TRUE}
library(caret)
set.seed(123)
indice <- createDataPartition(data$Survived, p = .80, list = FALSE)

#Aplica√ß√£o do √çndice na base
treinamento <- data[indice, ]
teste <- data[-indice, ]


#Ajuste do modelo de treinamento
m_train<- glm(Survived~Sex+Pclass+Age, family = binomial(link="logit"), data=treinamento)


#Predi√ß√£o da vari√°vel resposta no conjunto de teste
teste$Survived_pred <- predict(m_train, teste, type = "response")
teste$classifica<-ifelse(teste$Survived_pred>0.5,"Survived","Not Survived")

# Visualiza√ß√£o dos valores observados, preditos e classificados

valida<-teste[,c("Survived","Survived_pred","classifica")]
DT::datatable(valida, editable = list(target = 'row'))

```

]

]


---
# MRLog - Exerc√≠cio

.panelset[

.panel[.panel-name[R Code]

```{r step, eval=FALSE}

blorr:: blr_step_aic_both(m1)
```

]

.panel[.panel-name[Output]

```{r step_out, echo=FALSE}

blorr:: blr_step_aic_both(m1)
```
]

.panel[.panel-name[R Code Plot]

```{r step_plot, eval=FALSE}

m1 %>%
  blr_step_aic_both() %>%
  plot()
```

]

.panel[.panel-name[Plot]

```{r step_plot_out, echo=FALSE, comment=FALSE, message=FALSE}
m1 %>%
  blorr::blr_step_aic_both() %>%
  plot()
```
]


]

---
# Regress√£o Log√≠stica

## Bom trabalho pessoal!
 
```{r, out.width="70%", fig.align='center',echo=FALSE}
knitr::include_graphics("https://media2.giphy.com/media/QLtO7Hs5FXtJe/giphy-downsized.gif")
```

